---
echo: false
code-fold: true
monofont: Fira Code Light
execute:
  warning: false
  code-fold: true
---

# Country

In this section I will try to look at the `medium_country` data from a level higher - aggregated per country. I would like to see first a high-level intro to the data, see which countries drive the most users and revenue, try to identify a subset on which I can focus the analysis and lastly - try to give an advise to our client by just looking at this level.

```{r}
#| label: setup
library("here")
library("fs")
library("DT")
library("janitor")
library("scales")
library("tidyverse")

data_dir <- "data"
file_name <- "medium_country.csv"

medium_country_raw <- read_csv(
  path_join(c(here(), data_dir, file_name)),
  skip = 6
) |> 
  clean_names()

n_countries_total <- medium_country_raw$country |> unique() |> length()
```

The source file contains data on `r n_countries_total` in total and e.g. looks like this for Croatia

```{r}
#| label: show-example-raw-data
#| echo: true
medium_country_raw |> 
  filter(country == "Croatia") |> 
  arrange(desc(revenue)) |> 
  datatable()
```

The data is on country / medium level so I would like to collapse it down to just the country level grouping first and compute some additional high-level metrics.

```{r}
#| label: aggregate-to-country-level
#| echo: true
by_country <- 
  medium_country_raw |> 
  group_by(country) |> 
  summarise(
    # summable-metrics
    across(
      c(users, new_users, sessions, transactions, revenue),
      sum
    ),
    # take medians for the rates, shares, durations
    across(
      c(bounce_rate, pages_session, avg_session_duration, ecommerce_conversion_rate),
      median
    )
  ) |> 
  ungroup() |> 
  # calculate new columns
  mutate(
    revenue_per_transaction = revenue / transactions,
    new_users_share = new_users / users
  )

by_country |> filter(country == "Croatia")
```

Are there countries with very very low volume of transactions or users ?

```{r}
#| label: important-metrics-quantiles
#| echo: true
by_country |> 
  select(users, transactions, revenue) |> 
  map(quantile, probs = seq(0, 1, 0.05))
```

-   about 15% of the countries have less than 500 users - which seems quite low for the whole of 2022
-   setting \~ 20,000 as limit for revenue would cut off the lower 20th percentile of countries - which seems also good (perhaps even too low given that the upper percentiles are in 100,000s of euros)

Based on this quick checks I am inclined to set a very simple rule `revenue > 20,000` . I can go back to revise this later if needed - as well as look more into the lower revenue countries to see if there is something to be said for them separately.

The removed countries seem to be indeed small countries.

```{r}
#| label: show-low-revenue-countries
#| echo: true
by_country |> filter(revenue < 20000)
```

## Revenue map

Going to try and plot the revenue, transactions, users on a map of the world - just to see how does it look like, where is the volume concentrated etc.

```{r}
#| label: revenue-map
#| column: screen
#| out-width: 70%
#| fig-format: svg
library("rworldmap")

by_country_map <- joinCountryData2Map(
  by_country,
  joinCode = "NAME",
  nameJoinColumn = "country"
)
mapCountryData(by_country_map, nameColumnToPlot = "revenue")
```

I will start with the following simple rule - either revenue more than €20,000 or users or transactions volume b bigger than 500 (i will come back to adjust these in case there is still lots of noise or conversely i am missing some granularity)

```{r}
#| label: remove-low-revenue-countries
#| echo: true
#| code-fold: false
by_country <- by_country |> 
  filter(
    (revenue > 20000) | (users > 500) | (transactions > 500)
  )
```

## Which countries "drive" the most ?

Which countries drive the most users ?

```{r}
#| label: most-users-plot
#| echo: true
by_country |> 
  slice_max(order_by = users, n = 30) |> 
  mutate(country = fct_reorder(country, users)) |> 
  ggplot(aes(x = users, y = country)) +
  geom_col() +
  scale_x_continuous(labels = comma_format(), expand = c(0, 0.3)) +
  labs(
    title = "Which countries drive the most users ?",
    x = "# Users",
    y = NULL
  ) +
  theme_minimal()
```

It seems that it is similar for new users.

```{r}
#| label: most-new-users-plot
#| echo: true
by_country |> 
  slice_max(order_by = new_users, n = 30) |> 
  mutate(country = fct_reorder(country, new_users)) |> 
  ggplot(aes(x = new_users, y = country)) +
  geom_col() +
  scale_x_continuous(labels = comma_format(), expand = c(0, 0.3)) +
  labs(
    title = "Which countries drive the most new users ?",
    x = "# New Users",
    y = NULL
  ) +
  theme_minimal()
```

And I expect the same picture more or less for revenue

```{r}
#| label: most-revenue-plot
#| echo: true
by_country |> 
  slice_max(order_by = revenue, n = 30) |> 
  mutate(country = fct_reorder(country, revenue)) |> 
  ggplot(aes(x = revenue, y = country)) +
  geom_col() +
  scale_x_continuous(labels = comma_format(), expand = c(0, 0.3)) +
  labs(
    title = "Which countries drive the most revenue ?",
    x = "€ Revenue",
    y = NULL
  ) +
  theme_minimal()
```

I noticed something interesting here - Lithuania which was one of the top drivers for (new) users - in terms of revenue dropped significantly. I also have the sense that Australia - which was not even on the top 30 charts in terms of (new) users - jumped straight to the middle when we switched to revenue-view.

I would like to check this bit more in detail by ranking the countries with respect to these metrics and checking a bit the difference in these ranks.

```{r}
#| label: country-ranks
#| echo: true
country_ranks <- by_country |> 
  mutate(
    across(
      c(users, transactions, revenue),
      ~ dense_rank(desc(.x)),
      .names = "{col}_rank"
    )
  ) |> 
  select(country, ends_with("rank")) |> 
  arrange(transactions_rank)

datatable(country_ranks)
```

I would like to see which countries have either:

-   difference-in-ranks (users minus revenue rank) bigger than 20 or
-   the ratio of ranks is more than double (users to revenue rank)

```{r}
#| label: big-diff-in-country-ranks
#| echo: true
country_ranks |> 
  mutate(
    ranks_diff = abs(users_rank - revenue_rank),
    users_to_revenue_rank_ratio = users_rank / revenue_rank
    ) |> 
  filter(
    ranks_diff > 20 | users_to_revenue_rank_ratio >= 2
    ) |> 
  datatable()
```

Indeed it seems there are some interesting cases here:

-   Lithuania which is the 2nd biggest driver of users - is the 53rd place when it comes to revenue ?! This means that there are tons of users coming from Lithuania to the client's website but somehow they do not monetise them. This seems odd
-   In addition to Australia - also Ireland and Japan seem to be 2x higher ranked in terms of revenue compared to rank in terms of users. This means that even though they do not bring the highest volumes of users to the website - they still manage to monetise them quite well - something to be investigated perhaps later (e.g. check their channel mix and see if it is any different than the others)

Once more i want to make sure Lithuania is strange and compare against e.g.

```{r}
#| label: recheck-lithuania
by_country |> 
  filter(country %in% c("Lithuania", "Germany"))
```

Comparing the ratio of users vs. ratio of revenue for Lithuania vs. Germany

```{r}
#| label: lithuania-vs-germany
#| echo: true
compare_users <- by_country |> 
  filter(country %in% c("Lithuania", "Germany")) |> 
  select(country, users) |> 
  deframe()

compare_revenue <- by_country |> 
  filter(country %in% c("Lithuania", "Germany")) |> 
  select(country, revenue) |> 
  deframe()

c(
  users = compare_users,
  users_ratio = compare_users["Lithuania"] / compare_users["Germany"],
  
  revenue = compare_revenue,
  revenue_ratio = compare_revenue["Lithuania"] / compare_revenue["Germany"]
) |> 
  prettyNum(scientific = F)
```

Ok this is confirmation enough i guess - Lithuania is \~140% bigger than Germany in terms of bringing users to the client's website - however it is strangely 6% of the revenue that Germany brings !?

## Final overview of selected countries

```{r}
#| label: final-overview-selected-countries
by_country |> 
  summarise(n_countries = n_distinct(country))
```

## Market penetration

I would like to try out the following

-   we have the data on how many users from a country were customers with our client in 2022
-   we can get the data on countries population as well as proportion of population from each country that participates in tourism. these could be our \~ theoretical upper bound on the number of customers from a country i.e. imagining that every person from a country has purchased with the client - then we should see this number of users in the data
-   the ratio of the first point to the second - would give us another view on "market penetration" - in the sense that we can say `1 in N` people from Country-A has purchased with the client in 2022.
-   to tie this together - comparing these rations between *comparable* countries could give us an idea where we could boost our marketing efforts and increase the market presence.

[Proportion of population that participated in tourism](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Tourism_statistics)

More concretely:

```{r}
#| label: setup-market-penetration
#| echo: true
library("openintro")
library("eurostat")

# total population of countries
world_pop <- openintro::world_pop

country_population <-
  world_pop |> 
  as_tibble() |> 
  select(country, year_2020) |> 
  rename(population = year_2020)

# prorortion of population that participates in tourism
country_tourists <- 
  get_eurostat("tour_dem_totot") |>
  label_eurostat() |> 
  filter(
    duration == "1 night or over",
    c_dest == "All countries of the world",
    unit == "Number",
    time == ymd(20210101)
  )|> 
  select(geo, time, values) |>
  rename(country = geo, tourists = values)

# transactions ~ # of customers from country for our client
country_customers <- 
  by_country |> 
  filter(country != "(not set)") |> 
  slice_max(order_by = transactions, n = 10) |> 
  select(country, transactions, revenue, revenue_per_transaction) |> 
  rename(customers = transactions)

# stick it all together
country_penetration <- 
  country_customers |> 
  left_join(country_population, join_by(country)) |> 
  left_join(country_tourists, join_by(country)) |> 
  mutate(
    customers_share = customers / tourists,
    one_in_N_tourists_has_transacted = floor(1 / customers_share),
    customers_share = percent_format(accuracy = 0.001)(customers_share)
  ) |> 
  arrange(desc(customers_share))

datatable(country_penetration)
```

Not all countries got matched - the tourism data is only for EU but that would do.

```{r}
#| label: eu-market-penetration
#| echo: true
country_penetration |> 
  filter( !is.na(one_in_N_tourists_has_transacted) ) |> 
  select(
    country,
    customers,
    tourists,
    one_in_N_tourists_has_transacted,
    customers_share,
    revenue,
    revenue_per_transaction
  ) |> 
  datatable()
```

If my logic and flow are correct - the situation is as following:

-   1 in 962 Germans was a customer with our client in 2022
-   1 in 632 French was a customer with our client in 2022

Assuming these 2 are comparable markets, where our client has similar marketing initiatives, efforts, spend etc.

The argument would be - If we could get the same market penetration in Germany as we have in France - for instance by using the same "marketing playbook" they did in France. Then they could potentially increase their market penetration in Germany from `0.104% -> 0.158%` .

This would mean `r 0.00158 * 46994591`

```{r}
#| label: germany-potential
#| echo: true

# numbers from table above
current_revenue_germany <- 12906843
current_customers_germany <- 48819
current_revenue_per_customer_germany <- 264

tourists_germany <- 46994591

# the current and "hypothetical" customer share
# the client could achieve
current_customer_share_germany <- 0.00104
potential_customer_share_germany <- 0.00158

# potential customers if increase happens
potential_customers_germany <- floor(
  potential_customer_share_germany * tourists_germany
)
# potential revenue that follows from above
potential_revenue_germany <- (
  current_revenue_per_customer_germany * potential_customers_germany
)
# extra cash and uplift in revenue in Germany
c(
  increase_abs = comma_format(suffix = "€")(
    potential_revenue_germany - current_revenue_germany
  ),
  uplift = percent_format(accuracy = 0.01)(
    (potential_revenue_germany - current_revenue_germany) / current_revenue_germany
  )
)
```

## Throwaway things

### Users map

```{r}
#| label: users-map
#| column: screen
#| out-width: 70%
#| fig-format: svg
mapCountryData(by_country_map, nameColumnToPlot = "users")
```

### Transactions map

```{r}
#| label: transactions-map
#| column: screen
#| out-width: 70%
#| fig-format: svg
mapCountryData(by_country_map, nameColumnToPlot = "transactions")
```
